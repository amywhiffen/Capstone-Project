
# Title: Scraping Twitter using the API
# Author: Amy Whiffen
# Date: May 5, 2023
# Output: html_document

*This document demonstrates how I retrived tweets using the Twitter API.* 

*If you wish to use the code chunk below, replace "YOUR_BEARER_TOKEN" with your own bearer token.*

```{r}

bearer_token <- "YOUR_BEARER_TOKEN"

headers <- c(`Authorization` = sprintf('Bearer %s', bearer_token))

params <- list(`tweet.fields` = 'created_at,public_metrics')
 
# # List of tweet IDs to fetch
 tweet_ids <- c('77666300557672449', '84288229993492482', '85264567940300800', '92988777471016960', '96183462146473984', '103122446529474560', '103492095112773634', '104173469780029440', '113215680098217985', '131699855469973504', '156398707540099072', '246350512272846848', '248464811116081152', '252812966909587459', '276423128995995648', '278705642544455680', '281146878685499393', '287635777142288387', '292335516622409729', '296186322568241152', '326824455705853952', '331151122175778816', '338150759046737920', '347758474274430976', '363422202567204864', '366517405029109760', '378525749290233856', '383855824353103873', '388234925784064001', '393196628511064065', '400162048409346048', '400164641063858176', '400651402911158272', '400651972011130880', '403128283451367424', '418388051375980544', '420010429117890560', '420093832890679296', '422212511497457664', '422315409652875265', '422316071363047425', '422483147868348416', '424701767054786561', '430918865275854848', '433380111417901058', '434065936195551232', '436512805282664448', '469029371224023040', '471746698554146816', '476389093547720704', '478569128358199296', '484438051784253441', '497727264810094593', '505971366513094656', '507333679262466049', '514051532162359297', '520524849278877696', '536413382539485184', '544822387334971392', '551325823714983936', '558473061314613248', '563810689232691202', '575761425072787457', '577594215875637248', '586531014249447424', '621311568463163392', '623468592319873024', '628530692218056704', '629653009916674048', '629658191865978880', '632222911865225216', '634816073137786880', '642417145004040192', '645085874531762176', '645375092705370112', '645822780764762112', '649212637079846912', '663657504203739136', '668401561719189504', '670257081514131456', '675714490286088192', '679689720599805952', '686561786087247872', '690383395063488512', '698434389798219776', '702453159495671808', '718400727056588800', '723826897713549312', '725448717122326528', '727463666308780032', '728375446631501826', '733922928409104384', '735402779494211584', '736967794303107072', '739884819627249664', '754715678070935553', '757608624701210624', '758636028878057472', '764114057381240832', '764606846879600640', '768740455710334976', '775117628067160065', '776898183955881984', '790544429748785152', '799587564122292225', '801465963086512128', '805786055802834944', '806170971371700224', '812394541043056640', '829810864278667266', '832302278543626248', '833848353309982720', '834414900432744448', '834678578633662464', '842264909303959552', '872454929096613888', '893574349827059712', '894913109781086212', '896112303396933632', '898907099777970176', '901842472023855106', '910793880873979904', '913042070113341440', '926818733464498181', '927971614305681409', '928097908783755266', '928371586016538624', '930122300325851137', '930991637798453248', '931482751538221056', '932634757879533569', '944209124488876032', '947169185829982208', '953287615737982976', '955542975710298113', '956562044458815489', '961428018286776321', '964459410956455936', '978644046649360384', '984132561193627653', '1012310565417570304', '1017701193487978496', '1018578760432607232', '1034799522231267330',  '1037781022954467329', '1050748884916625408', '1052947871987888128', '1054716911894835201', '1058733298879512577', '1060906409225805827', '1066426384543830017', '1067065868717305856', '1088839555158102016', '1111244269283692544', '1117867536060542977', '1146422152071192576', '1147633715671195653', '1162385702052683776', '1166112609004924928', '1186927477513424896', '1203703944201035776', '1207257218669858819', '1214273263708385280', '1353001291593752577', '1370080230862381061', '1602279060268269568', '257521205131763712', '342515214203375617', '362153606981492736', '363214731156258818', '423664774359289856', '453292282289344512', '485279109027610625', '508698762362245120', '532668652727050240', '573556361721741313', '587379847191781376', '592545627428487168', '636196032506949633', '669266824710737921', '865233901224153089', '942176671611973633', '1060019500056281088', '1072427328893005824', '1091425867480383489')
 
 # Initialise an empty list to store data frames
 data_frames_list <- list()
 
 for (i in 1:length(tweet_ids)) {

   # Prepare the URL for the current tweet ID
      url_ids <- sprintf('https://api.twitter.com/2/tweets?ids=%s', tweet_ids[i])

       # Make the API request
      response <- httr::GET(url = url_ids,
                            httr::add_headers(.headers = headers),
                            query = params)
  
      # Parse the JSON response
      json_data <- fromJSON(httr::content(response, as = "text"), flatten = TRUE)

      # Convert JSON data to a data frame
      tweet_df <- as.data.frame(json_data$data)


      # Store the data frame in the list
      data_frames_list[[i]] <- tweet_df

      # Add a delay between API requests to avoid rate limiting
      Sys.sleep(63)
 }
 
# Combine all data frames into a single data frame
all_tweets_df <- do.call(rbind, data_frames_list)

# Convert list columns to character columns
all_tweets_df[] <- lapply(all_tweets_df, function(x) {
  if (is.list(x)) {
     return(sapply(x, toString))
   } else {
     return(x)
   }
 })
 
# Save all_tweets_df as a CSV file
# write.csv(all_tweets_df, "met_missing_tweets.csv", row.names = FALSE)

```